#!/bin/bash

busName=net.minecraft
busDir="${XDG_RUNTIME_DIR}/app/${busName}"

function moeDect() {
	if [[ -f /usr/share/moeOS-Docs/os-release ]]; then
		osRel="/usr/share/moeOS-Docs/os-release"
	else
		osRel="/usr/lib/os-release"
	fi

}

function sourceXDG() {
	if [[ ! ${XDG_CONFIG_HOME} ]]; then
		source "${HOME}"/.config/user-dirs.dirs
		export XDG_CONFIG_HOME="${HOME}"/.config
	else
		source "${XDG_CONFIG_HOME}"/user-dirs.dirs
	fi
	if [[ ! ${XDG_DATA_HOME} ]]; then
		export XDG_DATA_HOME="${HOME}"/.local/share
	fi
}

function createWrapIfNotExist() {
	if [ -d "$@" ]; then
		return 0
	else
		mkdir -p "$@"
	fi
}

function execApp() {
	mkdir -p /tmp/${busName}
	touch /tmp/${busName}/.flatpak-info
	echo "Launching App"
	bwrap \
		--cap-drop ALL \
		--dev /dev \
		--dev-bind /dev/dri /dev/dri \
		--dev-bind /dev/shm /dev/shm \
		--ro-bind /sys/dev/char /sys/dev/char \
		--ro-bind /sys/devices /sys/devices \
		--proc /proc \
		--tmpfs /tmp \
		--bind /usr /usr \
		--ro-bind /etc /etc \
		--symlink usr/lib /lib \
		--symlink usr/lib64 /lib64 \
		--symlink usr/bin /bin \
		--symlink usr/bin /sbin \
		--ro-bind /usr/bin/true /usr/bin/lsblk \
		--bind "${busDir}/bus" "${XDG_RUNTIME_DIR}/bus" \
		--ro-bind "${XDG_RUNTIME_DIR}/pulse" \
			"${XDG_RUNTIME_DIR}/pulse" \
		--ro-bind-try "${XAUTHORITY}" "${XAUTHORITY}" \
		--unshare-all \
		--share-net \
		--ro-bind-try "${XDG_CONFIG_HOME}"/user-dirs.dirs \
			"${XDG_CONFIG_HOME}"/user-dirs.dirs \
		--ro-bind-try "${XDG_CONFIG_HOME}"/fontconfig \
			"${XDG_CONFIG_HOME}"/fontconfig \
		--ro-bind-try "${XDG_CONFIG_HOME}"/mimeapps.list \
			"${XDG_CONFIG_HOME}"/mimeapps.list \
		--ro-bind-try "/tmp/${busName}/.flatpak-info" \
			"${XDG_RUNTIME_DIR}/.flatpak-info" \
		--ro-bind-try "/tmp/${busName}/.flatpak-info" \
			/.flatpak-info \
		--bind-try "${XDG_DATA_HOME}/PrismLauncher" \
			"${XDG_DATA_HOME}/PrismLauncher" \
		--ro-bind-try "${XDG_RUNTIME_DIR}/${WAYLAND_DISPLAY}" \
			"${XDG_RUNTIME_DIR}/${WAYLAND_DISPLAY}" \
		-- \
		$@
}

function dbusProxy() {
	mkdir "${busDir}" -p
	echo "Launching D-Bus Proxy"
	bwrap \
		--new-session \
		--symlink /usr/lib64 /lib64 \
		--ro-bind /usr/lib /usr/lib \
		--ro-bind /usr/lib64 /usr/lib64 \
		--ro-bind /usr/bin /usr/bin \
		--bind "${XDG_RUNTIME_DIR}" "${XDG_RUNTIME_DIR}" \
		--ro-bind-try "/tmp/${busName}/.flatpak-info" \
			/.flatpak-info \
		--ro-bind-try "/tmp/${busName}/.flatpak-info" \
			"${XDG_RUNTIME_DIR}/.flatpak-info" \
		--die-with-parent \
		-- \
		env -i xdg-dbus-proxy \
			"${DBUS_SESSION_BUS_ADDRESS}" \
			"${busDir}/bus" \
			--log \
			--call=org.freedesktop.portal.Desktop=*=* \
			--talk=org.gnome.Shell.Screenshot \
			--talk=org.freedesktop.portal.Screenshot \
			--broadcast=org.freedesktop.portal.*=@/org/freedesktop/portal/*
}

function launch() {
	moeDect
	execApp $@
}

dbusProxy &
sleep 0.5s
sourceXDG
launch $@