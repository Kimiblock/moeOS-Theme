#!/bin/bash

function _notify(){
	notify-send -i moeos -u normal -t 5 -a moeOS "moeOS Setup" "$1"
	sleep 2
}

function main(){
	if [ ! "${XDG_CONFIG_HOME}" ]; then
		export XDG_CONFIG_HOME="${HOME}/.config"
	fi
	cp -r /etc/gtk-{4,3}.0 "${HOME}/.config"
	lightMode
	checkExist
	_notify "Setting up moeOS"
	enableSnotify
	checkExist set
}

function enableSnotify(){
	systemctl --user enable --now snotify
}

function setupFont(){
	mkdir -p ~/.config/fontconfig
	cp /etc/fonts/conf.d/99-moeos.conf ~/.config/fontconfig/fonts.conf
}

function moeOS-setup-firefox(){
	bash "/usr/lib/moeOS/moeOS-setup-firefox" 1>/dev/null 2>/dev/null
}

function lightMode() {
	if [ ! -f ${XDG_CONFIG_HOME}/Kvantum/kvantum.kvconfig ]; then
		echo "[General]" >${XDG_CONFIG_HOME}/Kvantum/kvantum.kvconfig
		echo "theme=moeOS" >>${XDG_CONFIG_HOME}/Kvantum/kvantum.kvconfig
	fi
	scheme=$(gsettings get org.gnome.desktop.interface color-scheme)
	if [[ ${scheme} =~ default ]]; then
		gsettings set org.gnome.desktop.interface color-scheme \'prefer-light\'
	elif [[ ${scheme} =~ prefer-dark ]]; then
		gsettings set org.gnome.desktop.interface gtk-theme adw-gtk3-dark
		kvTheme=$(cat ${XDG_CONFIG_HOME}/Kvantum/kvantum.kvconfig | grep 'theme=')
		if [[ ${kvTheme} =~ moeOS-Dark ]]; then
			unset kvTheme
		elif [[ ${kvTheme} =~ moeOS ]]; then
			sed -i 's|theme=moeOS|theme=moeOS-Dark|g' ${XDG_CONFIG_HOME}/Kvantum/kvantum.kvconfig
		else
			echo "Kvantum theme not overrided"
		fi
	elif [[ ${scheme} =~ prefer-light ]]; then
		if [[ ${kvTheme} =~ moeOS-Dark ]]; then
			sed -i 's|theme=moeOS-Dark|theme=moeOS|g' ${XDG_CONFIG_HOME}/Kvantum/kvantum.kvconfig
		else
			echo "Kvantum theme not overrided"
		fi
		gsettings set org.gnome.desktop.interface gtk-theme adw-gtk3
	fi
}

function checkExist(){
	if [ "${_moeOS_Setup}" = 1 ]; then
		echo "_moeOS_Setup detected!"
	elif [ -f "${XDG_CONFIG_HOME}/moeOS/state" ]; then
		setupFont
		moeOS-setup-firefox
		exit 0
	fi
	if [[ "$@" =~ set ]]; then
		mkdir -p "${XDG_CONFIG_HOME}/moeOS"
		touch "${XDG_CONFIG_HOME}/moeOS/state"
		_notify "moeOS has been set up"
	fi
}

main