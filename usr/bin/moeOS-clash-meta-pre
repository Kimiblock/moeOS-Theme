#!/bin/bash
function download(){
	info "Downloading subscribe file..."
	execute curl `cat /etc/moeOS-clash-meta/subscribe.conf` -o /etc/moeOS-clash-meta/config.yaml
}

function execute(){
	"$@"
	if [[ $? = 0 ]]; then
		return 0
	else	
		err=$?
		info "Something went wrong, error code ${err}"
		exit ${err}
	fi
}

function addMissingTun(){
	info "Enabling TUN..."
	echo '''tun:
  enable: true
  stack: gvisor
  dns-hijack:
  - any:53
  auto-route: true
  auto-detect-interface: true''' >>/etc/moeOS-clash-meta/config.yaml
  echo "Done."
}

function enableTunInplace(){
	info 'Updating the yaml file...'
	execute yq -i '.tun.enable = "true"' /etc/moeOS-clash-meta/config.yaml
	echo done.
}

function info(){
	echo "  ==> [Info]: $@"
}

function mergeConfig(){
	if [[ $(cat /etc/moeOS-clash-meta/merge.yaml) ]]; then
		info 'Merging configuration...'
		yq ea '. as $item ireduce ({}; . * $item )' /etc/moeOS-clash-meta/{config.yaml,merge.yaml} >/etc/moeOS-clash-meta/config.yaml
	else
		info 'Skipping merge'
	fi

}

function main(){
	flags="$@"
	download
	mergeConfig
	if [[ $(yq '.tun.enable' /etc/moeOS-clash-meta/config.yaml) = null ]]; then
		addMissingTun
		info "Config check completed."
	elif [[ $(yq '.tun.enable' /etc/moeOS-clash-meta/config.yaml) = 'false' ]]; then
		info "TUN is disabled"
		enableTunInplace
		info "Config check completed."
	else
		info "Config check completed."
	fi
	if [[ ${flags} =~ redir-host ]]; then
		info 'Setting enhanced mode to redir-host...'
		yq -i '.dns.enhanced-mode = "redir-host"' /etc/moeOS-clash-meta/config.yaml
	fi
	if [[ ${flags} =~ fake-ip ]]; then
		info 'Setting enhanced mode to fake-ip...'
		yq -i '.dns.enhanced-mode = "fake-ip"' /etc/moeOS-clash-meta/config.yaml
	fi
}

main "$@"
