#!/bin/bash

videoMod=$(lsmod)

if [[ ${videoMod} =~ i915 ]] || [[ ${videoMod} =~ xe ]] || [[ ${videoMod} =~ amdgpu ]]; then
	bwArg="--dev /dev"
elif [[ ${videoMod} =~ nvidia ]]; then
	bwArg="--dev-bind /dev /dev"
fi

bwrap \
	--symlink usr/lib /lib \
	--symlink usr/lib64 /lib64 \
	--symlink usr/bin /bin \
	--symlink usr/bin /sbin \
	${bwArg} \
	--ro-bind /usr /usr \
	--ro-bind /etc /etc \
	--dev-bind /dev/dri /dev/dri \
	--dev-bind /dev/shm /dev/shm \
	--bind /proc /proc \
	--ro-bind /sys/dev/char /sys/dev/char \
	--ro-bind /sys/devices /sys/devices \
	--bind /run /run \
	--tmpfs /tmp \
	--bind "$HOME" "$HOME" \
	--setenv GTK_IM_MODULE ibus \
	-- /usr/bin/element-desktop \
		--ozone-platform=wayland \
		--enable-vulkan \
		--enable-zero-copy \
		--ignore-gpu-blocklist \
		--enable-features=VaapiVideoDecodeLinuxGL,VaapiIgnoreDriverChecks,VaapiVideoDecoder,WebRTCPipeWireCapturer,TouchpadOverscrollHistoryNavigation \
		--disable-features=UseChromeOSDirectVideoDecoder \
		--enable-wayland-ime
		$@
