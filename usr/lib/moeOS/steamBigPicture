#!/usr/bin/bash

function checkInst() {
	if [[ "$(flatpak list)" =~ com.valvesoftware.Steam ]]; then
		return 0
	else
		flatpak install --assumeyes --or-update flathub com.valvesoftware.Steam
	fi
}

function gbmProbe() {
	if [ -f /etc/environment.d/moeOS-nvidia*.conf ]; then
		nvidiaVer="$(pacman -Q nvidia-utils | sed -E 's/.* ([0-9]+\.[0-9]+\.[0-9]+)-([0-9]+)/\1/' | sed 's/\./-/g')"
		backendPath="/usr/lib/x86_64-linux-gnu/GL/nvidia-"${nvidiaVer}"/extra/gbm"
	fi
}

function main() {
	if [ ${ENABLE_HDR_WSI} = 1 ]; then
		optionsHDR="--hdr-debug-force-output --hdr-enabled"
		envHDR='ENABLE_GAMESCOPE_WSI=1 DXVK_HDR=1 DISABLE_HDR_WSI=1'
	fi
	gamescope \
		--force-grab-cursor \
		-W 1680 -H 1050 \
		-e \
		-f \
		${optionsHDR} \
		-F fsr \
		-- \
			env ${envHDR} \
			GBM_BACKENDS_PATH="${backendPath}" \
			flatpak run com.valvesoftware.Steam -bigpicture $@
}

checkInst
gbmProbe
main $@
